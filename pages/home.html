<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./style/home_style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <title>Home</title>
</head>

<body>
 <div class="container">
    <aside class="sidebar">
        <div class="logo">
            <img src="./images/home_icon.png" alt="Music Icon">
                <h4>SNM</h4>
        </div>
        <div class="menu">
            <ul>
                <li>              
                    <a class="nav-link active">
                        <i class='bx bxs-home-circle'> </i>
                        <span>Home</span>
                    </a>
                </li>
                    
                <li class="nav-item">
                    <a class="nav-link" href="/profilepage">
                        <i class='bx bx-user-circle'>  </i>
                        <span>Profile</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/publicplaylistspage">
                        <i class='bx bxs-playlist'>  </i>
                         <span>Playlists</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/createplaylistpage">
                        <i class='bx bx-list-plus'>  </i>
                        <span>Create</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>
    <main>
        <header>
            <div class="top">
                <div class="back" id="backSearch">
                    <a class="nav-link">
                        <i class='bx bx-caret-left-circle'></i>
                    </a>
                </div>
    
                <form method="GET" id="searchTrackForm">
                    <div class="search">
                        <i class='bx bx-search'></i>
                        <input type="text" placeholder="Cerca una canzone">
                    </div>
                </form>
            </div>
        </header>
         <!-- HomePage -->   
        <div class="search-results" id="search-results"></div>

        <div class="favArtists-container" id="favArtists-container">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper"></div>
                <div class="swiper-scrollbar"></div>
            </div>
        </div>
    
        <div class="recommendations-container" id="recommendations-container">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper"></div>
                <div class="swiper-scrollbar"></div>
            </div>
        </div>

    </main>

    <div class="right-section">

        <div class="profile">
            <div class="user" id="user">
                    <img src="./images/profile_icon.png">
                    <h5>Username</h5>
            </div>
        </div>  

        <div class="playlists" id="playlists">
            <div class="header">
                <div class="top">
                    <div class="dropdown">
                        <div class="dropdown-content">
                            <select id="playlistFilter">
                                <option value="My" selected>My</option>
                                <option value="Followed">Followed</option>
                            </select>
                        </div>
                    </div>
                    <h5>Playlists</h5>
                </div>
                <div class="bottom">
                    <div class="search">
                        <input type="text" id="searchMyPlaylists" placeholder="Trova playlist">
                    </div>
                    <a class="nav-link" href="/createplaylistpage"> <i class='bx bx-list-plus'></i></a>
                </div>
            </div>
            <div class="items"></div>
        </div>

        <div class="music-player" id="music-player"></div>

        <div id="playlistModal" class="modal">
            <div class="modal-content">
                <div class="top-section">
                    <span class="close" id="closeAddModal">&times;</span>
                    <h6>Aggiungi alla playlist</h6>
                </div>
                <div class="ItemsContainer"></div>
            </div>
        </div>

    </div>

</div>  

    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>


/*--------------------- SWIPER SCORRIMENTO ----------------------*/

    let swiper = new Swiper('.mySwiper', {
            slidesPerView: 'auto',
            spaceBetween: 16,
            scrollbar: {
            el: '.swiper-scrollbar',
            draggable: true,
            },

            pagination: {
            el: '.swiper-pagination',
            clickable: true,
            mousewheel: true,

            breakpoints: {
                320: {
                slidesPerView: 1,
                spaceBetween: 10,
                },
                768: {
                slidesPerView: 2,
                spaceBetween: 20,
                },
                1024: {
                slidesPerView: 2,
                spaceBetween: 30,
                },
            },
            },
        });

/*------------------------- DATI USER -----------------------*/

let user = {};

(async () => {
    const username = document.querySelector('#user h5');
    try{
        const response = await fetch('/user/data', {
            method:'GET',
        });
        if(response.ok){
            const data = await response.json();
            user = data.data;
            username.innerHTML = user.username;
        } else {
            console.error("errore nel prelievo dati utente")
        }
    } catch(error){
        console.error(error);
    }
})(); 

const userContainer = document.querySelector('#user');
userContainer.addEventListener('click', () => {
    window.location.href = '/profilepage';
});

/*-------------------------- ARTISTI PREFERITI --------------------------*/

    fetch('/user/getArtists')
    .then((response) => response.json())
    .then((data) => {
      if (data.status === 'success') {
            const favArtists = data.data.artistiPreferiti;
            const favArtistsWrapper = document.getElementById('favArtists-container').querySelector('.swiper-wrapper');

            favArtists.forEach((favArtist) => {
                const favArtistBox = document.createElement('div');
                favArtistBox.classList.add('favArtist-box');

                const favArtistName = document.createElement('h3');
                favArtistName.textContent = favArtist.nome;
                favArtistName.classList.add('favArtist-nome');

                const favArtistImage = document.createElement('img');
                favArtistImage.src = favArtist.immagine;
                favArtistImage.alt = favArtist.nome;

                favArtistBox.appendChild(favArtistImage);
                favArtistBox.appendChild(favArtistName);

                const swiperSlide = document.createElement('div');
                swiperSlide.classList.add('swiper-slide');
                swiperSlide.appendChild(favArtistBox);
                favArtistsWrapper.appendChild(swiperSlide);
 
                });   
      } else {
        console.log("Non sono presenti preferenze su artisti");
      }
    }); 

/*-------------------------- CANZONI RACCOMANDATE --------------------------*/

    fetch('/spotify/getRecommendations')
    .then((response) => response.json())
    .then((data) => {
      if (data.status === 'success') {
        const recommendedTracks = data.data.tracks;
        const recommendationsWrapper = document.getElementById('recommendations-container').querySelector('.swiper-wrapper');

        recommendedTracks.forEach((rectrack) => {

          const rectrackBox = document.createElement('div');
          rectrackBox.classList.add('rectrack-box');

          const rectrackName = document.createElement('h3');
          rectrackName.textContent = rectrack.name;
          rectrackName.classList.add('rectrack-name');

          const rectrackArtist = document.createElement('p');
          rectrackArtist.textContent = rectrack.artists.map(artist => artist.name).join(', ');
          rectrackArtist.classList.add('rectrack-artist');

          const rectrackImage = document.createElement('img');
          rectrackImage.src = rectrack.album.images[0].url;
          rectrackImage.alt = rectrack.name;

          rectrackBox.appendChild(rectrackName);
          rectrackBox.appendChild(rectrackArtist);
          rectrackBox.appendChild(rectrackImage);          

          rectrackBox.addEventListener('click', async () => {
                    displayTrack(rectrack.id);
          });

          const swiperSlide = document.createElement('div');
          swiperSlide.classList.add('swiper-slide');
          swiperSlide.appendChild(rectrackBox);
          recommendationsWrapper.appendChild(swiperSlide);
         
        });   
        
      } else {
        console.log("Non sono presenti preferenze su artisti o generi");
      }
    }); 

/*----------------------- SEARCH MY PLAYLISTS -----------------------*/

const searchMyPlaylists = document.getElementById('searchMyPlaylists');

searchMyPlaylists.addEventListener('input', () => {
        const searchValue = searchMyPlaylists.value.toLowerCase();
        const playlists = document.querySelectorAll('.item');

        let found = false; 
        playlists.forEach((playlist) => {
            const playlistName = playlist.querySelector('h5').textContent.toLowerCase();
            if (searchValue.length > 0 && playlistName.includes(searchValue)) {
                playlist.classList.add('found');
                found = true;
            } else {
                playlist.classList.remove('found');
            }
        });
        if (found) {
            const foundPlaylist = document.querySelector('.found');
            foundPlaylist.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });


/*----------------------- MY/FOLLOWED PLAYLISTS -----------------------*/

const rightSection = document.querySelector('.right-section');
const playlistsContainer = document.querySelector('.items');
const rightSectionContent = rightSection.innerHTML;

async function getPlaylists(selectedOption){
    playlistsContainer.innerHTML='';
    try {
        const response = await fetch(`/playlist/get${selectedOption}Playlists`);
        if (!response.ok) {
            throw new Error('Errore nel recupero delle playlist');
        }
        const data = await response.json();
        const playlists = data.data;
        displayedPlaylists = await playlists;

        playlists.forEach((playlist, index) => {
            const playlistItem = document.createElement('div');
            playlistItem.classList.add('item');

            const playlistImage = document.createElement('img');
            if(playlist.tracce.length === 0) {
                playlistImage.src = './images/playlist-default.jpg'; 
            } else {
                playlistImage.src = playlist.tracce[0].immagine; 
            }

            const infoDiv = document.createElement('div');
            infoDiv.classList.add('info');
            infoDiv.appendChild(playlistImage);

            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('details');
            detailsDiv.innerHTML = `
                <h5>${playlist.nome}</h5>
                <p>${playlist.owner}</p>`;

            infoDiv.appendChild(detailsDiv);
            playlistItem.appendChild(infoDiv);

                playlistItem.addEventListener('click', async (e) => {
                    window.location.href = `/publicplaylistspage?playlistId=${playlist._id}`;
                });

                playlistsContainer.appendChild(playlistItem);
        });
    } catch (error) {
        console.error('Errore nel recupero delle playlist:', error);
    }
}

let selectedOption = 'My';
getPlaylists(selectedOption);
const playlistFilter = document.getElementById('playlistFilter');
playlistFilter.addEventListener('change', function() {
        selectedOption = playlistFilter.value;
        getPlaylists(selectedOption);
});

/*--------------------- RICERCA CANZONE --------------------*/

const searchTrackForm = document.getElementById('searchTrackForm');

searchTrackForm.addEventListener('click', async (e) => {

        document.getElementById('favArtists-container').style.display = 'none';
        document.getElementById('recommendations-container').style.display = 'none';

        document.getElementById('search-results').style.display = 'block';
        backButton.style.display="block";
        searchTrackForm.addEventListener('input', async (e) => {

            const query = e.target.value;
            if (query.length > 1 && query.trim !== '') {
                try {
                    const response = await fetch(`/spotify/searchTracks?query=${query}`);
                    const data = await response.json();
                    if (response.ok) {
                        displaySearchResults(data.data);
                        
                    } else {
                        console.error('Errore nella ricerca delle tracce:', data.error);
                    }
                } catch (error) {
                    console.error('Errore nella ricerca delle tracce:', error);
                }
            }
        });

});

let trackId;

function displaySearchResults(tracks) {
        
        document.getElementById('search-results').style.display = 'block';

        const SearchWrapper = document.getElementById('search-results');
        SearchWrapper.innerHTML = '';

        tracks.forEach((track) => {
            const trackBox = document.createElement('div');
            trackBox.classList.add('track-box');

            const trackInfo = document.createElement('div');
            trackInfo.classList.add('track-info');

            const trackImage = document.createElement('img');
            trackImage.src = track.album.images[0].url;
            trackImage.alt = track.name;

            const trackName = document.createElement('h3');
            trackName.textContent = track.name;
            trackName.classList.add('track-name');

            const trackArtist = document.createElement('p');
            trackArtist.textContent = track.artists.map(artist => artist.name).join(', ');
            trackArtist.classList.add('rectrack-artist');

            trackInfo.appendChild(trackName);
            trackInfo.appendChild(trackArtist);

            trackBox.appendChild(trackImage);
            trackBox.appendChild(trackInfo);
            
                trackBox.addEventListener('click', async () => {
                    displayTrack(track.id);
                });
                SearchWrapper.appendChild(trackBox);

            });
}

/* ---------------------- RETRY RICERCA ---------------------*/

const backButton = document.getElementById('backSearch');

backButton.addEventListener('click', async () => {
    const searchInput = document.querySelector('#searchTrackForm input[type="text"]');
    searchInput.value = '';

    document.getElementById('search-results').style.display = 'none';
    backButton.style.display='none';
    document.getElementById('favArtists-container').style.display = 'block';
    document.getElementById('recommendations-container').style.display = 'block';
    document.querySelector('.right-section').style.display = 'block';



});

/* ---------------------- DISPLAY TRACK ---------------------- */

const musicPlayer = document.getElementById('music-player');
musicPlayer.style.display='none';
document.getElementById('playlistModal').style.display='none';
const closeAddModal = document.getElementById('closeAddModal');

async function displayTrack(trackId){

document.getElementById('playlists').style.display='none';

try {
const response = await fetch(`/spotify/getTracks/${trackId}`);
const data = await response.json();
if (response.ok) {
    console.log('Dati traccia:', data);
    const track = data.data;
    console.log(track);
    const duration = new Date(track.duration_ms);
    const minutes = duration.getMinutes();
    const seconds = duration.getSeconds();
    const secondsString =
    seconds < 10 ? '0' + seconds : seconds;
    const minutesString =
    minutes < 10 ? '0' + minutes : minutes;

    const genresHTML = track.genres.map(genre => `<span>${genre}</span>`).join(', ');

    musicPlayer.innerHTML='';
    musicPlayer.innerHTML = `
            <div class="top-section">
                <div class="header">
                    <div class="music-back">
                        <a class="nav-link">
                            <i class='bx bx-chevron-up bx-rotate-270' id="musicBackButton" ></i>
                        </a>
                    </div>
                    <h5>Selected Song</h5>
                    <i class='bx bxs-playlist' id=addToPlaylistButton></i>
                </div>
                <div class="song-info">
                    <img src="${track.album.images[0].url}">
                    <div class="description">
                        <h3>${track.name}</h3>
                        <h5>${track.artists[0].name}</h5>
                        <p>${track.album.name}&nbsp;${track.album.release_date}</p>
                        <p>${genresHTML}</p>
                    </div>
                    <div class="progress">
                        <p>${minutesString}:${secondsString}</p>
                    </div>
                </div>
            </div>

            <div class="player-actions">
                <div class="buttons">
                    <i class='bx bx-right-arrow' ></i>
                </div>
            </div>`; 

            document.getElementById('musicBackButton').addEventListener('click', () => {
                musicPlayer.style.display='none'
                document.getElementById('playlists').style.display='block';
            })
            musicPlayer.style.display='block';
/*-------------------------------- ADD TRACK --------------------------------*/

    const addToPlaylistButton = document.getElementById('addToPlaylistButton');
        
    addToPlaylistButton.addEventListener('click', async () => {

            let userPlaylists = [];

            try {
                const response = await fetch('/playlist/getMyPlaylists');
                const data = await response.json();
                
                if (response.ok) {
                    userPlaylists.push(...data.data);
                    await openPlaylistModal(userPlaylists, trackId);
                } else {
                    console.error('Errore recupero playlists:', data.error);
                }
            } catch (error) {
                console.error('Errore richiesta playlists:', error);
            }
        });


        async function openPlaylistModal(playlists,trackId) {
        const modal = document.getElementById('playlistModal');
        modal.style.display='block';
        const ItemsContainer = modal.querySelector('.ItemsContainer');
        ItemsContainer.innerHTML = '';

        playlists.forEach((playlist) => {
            const playlistItem = document.createElement('div');
                playlistItem.classList.add('item');

                const playlistImage = document.createElement('img');
            if(playlist.tracce.length === 0) {
                playlistImage.src = './images/playlist-default.jpg'; 
            } else {
                playlistImage.src = playlist.tracce[0].immagine; 
            }

            const infoDiv = document.createElement('div');
            infoDiv.classList.add('info');
            infoDiv.appendChild(playlistImage);

            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('details');
            detailsDiv.innerHTML = `
                <h5>${playlist.nome}</h5>`;

            infoDiv.appendChild(detailsDiv);
            playlistItem.appendChild(infoDiv);

            playlistItem.addEventListener('click', () => {
                addTrackToPlaylist(playlist._id,trackId); 
                
            });

            closeAddModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';   
                }
            });

            ItemsContainer.appendChild(playlistItem);
        });


        }

        async function addTrackToPlaylist(playlistId,trackId) {
        try {
            console.log(trackId);
            const response = await fetch(`/playlist/addTrack?playlist_id=${playlistId}&track_id=${trackId}`, {
                method: 'POST',
            });
            if (response.ok) {
                console.log('Traccia aggiunta alla playlist');
                document.getElementById('playlistModal').style.display='none'; 
            } else {
                console.error('Errore durante l\'aggiunta della traccia alla playlist');
            }
        } catch (error) {
            console.error('Errore durante la richiesta di aggiunta traccia alla playlist:', error);
        }
        }

    } else {
        console.error('Errore dati traccia:', data.error);
    }
} catch (error) {
    console.error('Errore recupero dati traccia:', error);
}

}


    </script>
</body>
</html>

